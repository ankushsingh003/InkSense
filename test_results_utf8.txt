============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-8.3.4, pluggy-1.5.0 -- D:\anaconda\python.exe
cachedir: .pytest_cache
rootdir: D:\ink_detection_fragments
plugins: anyio-4.12.1, langsmith-0.4.43
collecting ... collected 3 items

tests/test_core.py::test_model_output_shape FAILED                       [ 33%]
tests/test_core.py::test_dataset_tile_generation FAILED                  [ 66%]
tests/test_core.py::test_model_gradients FAILED                          [100%]

================================== FAILURES ===================================
___________________________ test_model_output_shape ___________________________

    def test_model_output_shape():
        """
        Test that the model accepts (B, Z, H, W) and returns (B, 1, H, W).
        """
        device = torch.device('cpu')
        model = VesuviusModel().to(device)
    
        # Batch size 2, 32 slices, 256x256 tiles
        dummy_input = torch.randn(2, 32, 256, 256).to(device)
>       output = model(dummy_input)

tests\test_core.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
D:\anaconda\Lib\site-packages\torch\nn\modules\module.py:1776: in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
D:\anaconda\Lib\site-packages\torch\nn\modules\module.py:1787: in _call_impl
    return forward_call(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = VesuviusModel(
  (encoder3d): Sequential(
    (0): Conv3d(1, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, ...=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): ReLU()
    (2): Conv2d(64, 1, kernel_size=(1, 1), stride=(1, 1))
  )
)
x = tensor([[[[ 4.9272e-01,  1.4738e+00, -1.1512e+00,  ..., -5.9929e-01,
            5.2909e-01, -9.0216e-01],
          [...353e-01],
          [ 8.6931e-01,  3.0582e-01,  2.8307e-01,  ..., -2.0719e+00,
            1.1378e+00,  1.2445e+00]]]])

    def forward(self, x):
        # x: (Batch, 1, Z, H, W)
>       batch, c, z, h, w = x.shape
E       ValueError: not enough values to unpack (expected 5, got 4)

model.py:59: ValueError
________________________ test_dataset_tile_generation _________________________

    def test_dataset_tile_generation():
        """
        Test that the dataset correctly generates tiles of the requested size.
        """
        # Create dummy data files
        vol = np.random.rand(32, 512, 512).astype(np.float32)
        lbl = np.random.rand(512, 512).astype(np.float32)
        msk = np.ones((512, 512)).astype(np.uint8)
    
        np.save("test_vol.npy", vol)
        np.save("test_lbl.npy", lbl)
        np.save("test_msk.npy", msk)
    
        ds = VesuviusDataset("test_vol.npy", "test_lbl.npy", "test_msk.npy", tile_size=256)
    
        # Get first item
        image, label = ds[0]
    
>       assert image.shape == (32, 256, 256), f"Wrong image tile shape: {image.shape}"
E       AssertionError: Wrong image tile shape: torch.Size([1, 32, 256, 256])
E       assert torch.Size([1, 32, 256, 256]) == (32, 256, 256)
E         
E         At index 0 diff: 1 != 32
E         Left contains one more item: 256
E         
E         Full diff:
E         + torch.Size([1, 32, 256, 256])
E         - (...
E         
E         ...Full output truncated (4 lines hidden), use '-vv' to show

tests\test_core.py:44: AssertionError
____________________________ test_model_gradients _____________________________

    def test_model_gradients():
        """
        Ensure that gradients flow through the model back to inputs.
        """
        model = VesuviusModel()
        input_data = torch.randn(1, 32, 128, 128, requires_grad=True)
>       output = model(input_data)

tests\test_core.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
D:\anaconda\Lib\site-packages\torch\nn\modules\module.py:1776: in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
D:\anaconda\Lib\site-packages\torch\nn\modules\module.py:1787: in _call_impl
    return forward_call(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = VesuviusModel(
  (encoder3d): Sequential(
    (0): Conv3d(1, 32, kernel_size=(3, 3, 3), stride=(1, 1, 1), padding=(1, ...=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): ReLU()
    (2): Conv2d(64, 1, kernel_size=(1, 1), stride=(1, 1))
  )
)
x = tensor([[[[ 0.3678, -0.3415, -0.1867,  ..., -0.1750, -0.4781, -1.1331],
          [ 0.1313, -0.0997, -1.4502,  ..., -1...0.4009, -0.4713],
          [ 1.6530,  0.5645, -1.4192,  ...,  0.9413, -0.6504,  1.4362]]]],
       requires_grad=True)

    def forward(self, x):
        # x: (Batch, 1, Z, H, W)
>       batch, c, z, h, w = x.shape
E       ValueError: not enough values to unpack (expected 5, got 4)

model.py:59: ValueError
=========================== short test summary info ===========================
FAILED tests/test_core.py::test_model_output_shape - ValueError: not enough v...
FAILED tests/test_core.py::test_dataset_tile_generation - AssertionError: Wro...
FAILED tests/test_core.py::test_model_gradients - ValueError: not enough valu...
============================== 3 failed in 2.79s ==============================
